<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Universe 7.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #6d28d9;
            --danger: #ef4444;
            --glass: rgba(15, 23, 42, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #f1f5f9;
            --bg-gradient: linear-gradient(135deg, #020617 0%, #1e1b4b 100%);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-gradient);
            height: 100dvh; color: var(--text); overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* UI GERAL */
        .glass-panel { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* TOAST */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: #1e293b; padding: 12px 20px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--primary); color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-size: 14px; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; animation: slideIn 0.3s ease; }
        .toast.error { border-left-color: var(--danger); }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* LOGIN */
        #auth-screen { display: flex; width: 100%; height: 100%; justify-content: center; align-items: center; flex-direction: column; z-index: 50; position: absolute; background: var(--bg-gradient); }
        .login-card { width: 90%; max-width: 350px; padding: 30px; text-align: center; }
        input { width: 100%; padding: 14px; margin: 8px 0; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); border-radius: 8px; color: white; font-size: 16px; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px; font-size: 15px; }
        .secondary-btn { background: transparent; border: 1px solid var(--glass-border); }

        /* APP LAYOUT */
        #app-screen { display: none; width: 100%; height: 100%; max-width: 1600px; position: relative; overflow: hidden; }
        
        .sidebar { 
            width: 320px; height: 100%; display: flex; flex-direction: column; 
            border-right: 1px solid var(--glass-border); background: #0f172a;
            position: absolute; left: 0; top: 0; z-index: 20; transition: transform 0.3s ease;
        }
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { padding: 14px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; color: #cbd5e1; }
        .chat-item.active { background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); color: white; }

        .chat-area { 
            width: 100%; height: 100%; padding-left: 320px; display: flex; flex-direction: column; 
            background: #020617; transition: all 0.3s ease; 
        }

        .chat-header { padding: 10px 15px; border-bottom: 1px solid var(--glass-border); background: rgba(15, 23, 42, 0.95); display: flex; justify-content: space-between; align-items: center; height: 60px; z-index: 15; }
        .back-btn { display: none; background: none; border: none; color: white; margin-right: 10px; padding: 5px; }
        
        #messages-list { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: #334155; border-bottom-left-radius: 2px; }
        
        .input-area { 
            padding: 10px; background: #0f172a; border-top: 1px solid var(--glass-border); 
            display: flex; gap: 8px; align-items: center; position: relative; z-index: 25;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .icon-btn { width: 42px; height: 42px; flex-shrink: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #cbd5e1; cursor: pointer; }

        /* GIPHY & MODALS */
        #sticker-picker {
            position: absolute; bottom: 70px; left: 10px; width: 300px; height: 350px;
            background: #1e293b; border: 1px solid var(--glass-border);
            border-radius: 12px; display: none; flex-direction: column; 
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5); z-index: 30; overflow: hidden;
        }
        #sticker-results { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .sticker-img { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 100; padding: 20px; }
        .modal-content { width: 100%; max-width: 450px; position: relative; max-height: 90vh; overflow-y: auto; padding: 25px; }
        .hidden-input { display: none; }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .sidebar { width: 100%; transform: translateX(0); }
            .sidebar.hidden { transform: translateX(-100%); }
            .chat-area { padding-left: 0; width: 100%; position: absolute; left: 0; top: 0; transform: translateX(100%); }
            .chat-area.active { transform: translateX(0); }
            .back-btn { display: block; }
            #sticker-picker { width: 95%; left: 2.5%; bottom: 80px; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- LOGIN -->
    <div id="auth-screen">
        <div class="glass-panel login-card">
            <h1 style="margin-bottom:20px; background: linear-gradient(to right, #a78bfa, #2dd4bf); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Chat Universe 7.2</h1>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="password" placeholder="Senha">
            <input type="text" id="username" placeholder="Nome (Cadastro)" style="display:none">
            <button onclick="handleLogin()" id="btn-login">ENTRAR</button>
            <button class="secondary-btn" onclick="toggleAuth()" id="btn-toggle">Criar Conta</button>
        </div>
    </div>

    <!-- APP -->
    <div id="app-screen">
        <div class="sidebar" id="sidebar">
            <div style="padding:20px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; gap:10px; align-items:center" onclick="openSettings()">
                <img id="sidebar-avatar" style="width:40px; height:40px; border-radius:50%; background:#000" src="">
                <div style="font-weight:bold" id="sidebar-name">...</div>
            </div>
            <div style="padding:10px">
                <button onclick="openAddModal()" class="secondary-btn" style="width:100%">+ Nova Conversa</button>
            </div>
            <div class="chat-list" id="chat-list"></div>
            <button onclick="logout()" class="secondary-btn" style="margin:10px; color:#ef4444; border-color:rgba(239,68,68,0.3)">Sair</button>
        </div>

        <div class="chat-area" id="chat-area">
            <div class="chat-header">
                <div style="display:flex; align-items:center;">
                    <button class="back-btn" onclick="closeChatMobile()"><span class="material-icons">arrow_back</span></button>
                    <div id="chat-title-text" style="font-weight:bold;">Chat</div>
                </div>
            </div>
            <div id="messages-list"></div>
            <div class="input-area" id="input-area" style="display:none">
                <!-- Picker GIPHY -->
                <div id="sticker-picker">
                    <input type="text" placeholder="Buscar figurinha..." style="margin:10px; width:calc(100% - 20px)" onkeyup="searchStickers(this.value)">
                    <div id="sticker-results"></div>
                </div>

                <button class="icon-btn" onclick="toggleStickers()"><span class="material-icons">emoji_emotions</span></button>
                <label for="file-input" class="icon-btn"><span class="material-icons">photo_camera</span></label>
                <input type="file" id="file-input" class="hidden-input" accept="image/*" onclick="this.value=null" onchange="uploadFileImgBB(this)">
                
                <input type="text" id="msg-input" placeholder="Mensagem..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="icon-btn" onclick="sendMessage()" style="background:var(--primary); border:none; color:white"><span class="material-icons">send</span></button>
            </div>
        </div>
    </div>

    <!-- MODAL NOVA CONVERSA -->
    <div id="modal-add" class="modal">
        <div class="glass-panel modal-content">
            <button onclick="closeModals()" style="float:right; background:none; border:none; color:white">X</button>
            <h3>Novo Chat</h3>
            <input type="text" id="new-group-name" placeholder="Nome do Grupo">
            <button onclick="createGroup()">Criar Grupo</button>
            <hr style="border:0; border-top:1px solid #333; margin:15px 0">
            <input type="email" id="new-contact-email" placeholder="Email do amigo">
            <button onclick="addPrivateChat()" class="secondary-btn">Chat Privado</button>
        </div>
    </div>
    
    <!-- MODAL SETTINGS -->
    <div id="modal-settings" class="modal">
        <div class="glass-panel modal-content" style="text-align:center">
            <button onclick="closeModals()" style="float:right; background:none; border:none; color:white">X</button>
            <h3>Meu Perfil</h3>
            <label for="avatar-upload">
                <img id="settings-avatar" style="width:100px; height:100px; border-radius:50%; margin:10px auto; display:block; cursor:pointer; border:2px solid var(--primary)" src="">
                <div style="font-size:12px; color:#94a3b8">Clique na foto para alterar</div>
            </label>
            <input type="file" id="avatar-upload" class="hidden-input" accept="image/*" onchange="updateProfileImageImgBB(this)">
            <input type="text" id="edit-name" placeholder="Seu nome">
            <button onclick="saveProfileChanges()">Salvar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, set, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        
        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDLzKVUFDu9mL_38bQ65V6ATrUCyn1MmaY",
            authDomain: "chat-ba44c.firebaseapp.com",
            databaseURL: "https://chat-ba44c-default-rtdb.firebaseio.com",
            projectId: "chat-ba44c",
            storageBucket: "chat-ba44c.firebasestorage.app",
            messagingSenderId: "802680335472",
            appId: "1:802680335472:web:bf121d0615669c17fc58b5"
        };
        
        // --- CHAVES DE API ---
        const GIPHY_API_KEY = "0UTRbFtkMxAplmr0kwDIziY866Snk3b0"; 
        const IMGBB_API_KEY = "4e5f37cc12948ad4ac9531a0fb466789"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let user = null;
        let currentChatId = null;
        let isRegistering = false;

        // TOAST SYSTEM
        window.showToast = (msg, type='success') => {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `toast ${type}`;
            div.innerHTML = `<span>${msg}</span>`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        };

        // --- AUTH ---
        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const name = document.getElementById('username').value;
            
            try {
                if(isRegistering) {
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(cred.user, { displayName: name });
                    await set(ref(db, 'users/' + cred.user.uid), { name, email, photo: "", uid: cred.user.uid });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) { showToast(e.message, "error"); }
        };

        window.toggleAuth = () => {
            isRegistering = !isRegistering;
            document.getElementById('username').style.display = isRegistering ? 'block' : 'none';
            document.getElementById('btn-login').innerText = isRegistering ? "CADASTRAR" : "ENTRAR";
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                user = u;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                document.getElementById('sidebar-name').innerText = user.displayName;
                const snap = await get(ref(db, `users/${user.uid}`));
                document.getElementById('sidebar-avatar').src = snap.val()?.photo || user.photoURL || "https://ui-avatars.com/api/?name=" + user.displayName;
                loadChats();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        // --- CHATS ---
        function loadChats() {
            document.getElementById('chat-list').innerHTML = "";
            onChildAdded(ref(db, `users/${user.uid}/private_groups`), snap => createChatItem(snap.key, snap.val().groupName));
            onChildAdded(ref(db, `users/${user.uid}/chats`), snap => createChatItem(snap.key, snap.val().friendName));
        }

        function createChatItem(id, name) {
            if(document.getElementById(`chat-${id}`)) return;
            const div = document.createElement('div');
            div.id = `chat-${id}`;
            div.className = 'chat-item';
            div.innerText = name;
            div.onclick = () => openChat(id, name);
            document.getElementById('chat-list').appendChild(div);
        }

        window.openChat = (id, name) => {
            currentChatId = id;
            document.getElementById('chat-title-text').innerText = name;
            document.getElementById('input-area').style.display = 'flex';
            document.getElementById('messages-list').innerHTML = "";
            
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('chat-area').classList.add('active');
            }

            onValue(ref(db, `messages/${id}`), snap => {
                document.getElementById('messages-list').innerHTML = "";
                snap.forEach(c => renderMessage(c.val()));
                const list = document.getElementById('messages-list');
                list.scrollTop = list.scrollHeight;
            });
        };

        window.closeChatMobile = () => {
            document.getElementById('chat-area').classList.remove('active');
            document.getElementById('sidebar').classList.remove('hidden');
        };

        window.sendMessage = (content=null, type='text') => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!content && !text) return;
            
            push(ref(db, `messages/${currentChatId}`), {
                text: content || text,
                type: type,
                sender: user.displayName,
                senderId: user.uid,
                avatar: user.photoURL,
                timestamp: Date.now()
            });
            input.value = "";
        };

        function renderMessage(msg) {
            const isMe = msg.senderId === user.uid;
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            let content = `<div>${msg.text}</div>`;
            if(msg.type === 'image') content = `<img src="${msg.text}" style="max-width:100%; border-radius:8px">`;
            if(msg.type === 'sticker') {
                content = `<img src="${msg.text}" style="max-width:150px">`;
                div.style.background = "transparent";
                div.style.padding = "0";
            }
            
            div.innerHTML = isMe ? content : `<div style="font-size:10px; color:#a78bfa; margin-bottom:2px">${msg.sender}</div>${content}`;
            document.getElementById('messages-list').appendChild(div);
        }

        // --- GIPHY ---
        window.toggleStickers = () => {
            const p = document.getElementById('sticker-picker');
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
            if(p.style.display === 'flex') searchStickers('trending');
        };

        window.searchStickers = async (q) => {
            const resDiv = document.getElementById('sticker-results');
            if(!q) q = 'trending';
            resDiv.innerHTML = "<div style='color:#ccc; text-align:center'>Carregando...</div>";
            
            try {
                const url = `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${q}&limit=10&rating=g`;
                const req = await fetch(url);
                const json = await req.json();
                
                resDiv.innerHTML = "";
                json.data.forEach(gif => {
                    const img = document.createElement('img');
                    img.src = gif.images.fixed_height_small.url;
                    img.className = 'sticker-img';
                    img.onclick = () => {
                        sendMessage(gif.images.fixed_height.url, 'sticker');
                        document.getElementById('sticker-picker').style.display = 'none';
                    };
                    resDiv.appendChild(img);
                });
            } catch(e) { resDiv.innerHTML = "<div style='color:red'>Erro Giphy</div>"; }
        };

        // --- SISTEMA DE UPLOAD COM IMGBB (GRÁTIS) ---
        
        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);

            // Chave configurada automaticamente:
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST",
                body: formData
            });

            const data = await response.json();
            if(data.success) {
                return data.data.url;
            } else {
                throw new Error("Erro ImgBB: " + (data.error ? data.error.message : "Desconhecido"));
            }
        }

        window.uploadFileImgBB = async (input) => {
            const file = input.files[0];
            if(!file) return;

            showToast("Enviando imagem...", "info");

            try {
                const url = await uploadToImgBB(file);
                sendMessage(url, 'image');
                showToast("Imagem enviada!");
            } catch(error) {
                showToast(error.message, "error");
            }
        };

        window.updateProfileImageImgBB = async (input) => {
            const file = input.files[0];
            if(!file) return;
            showToast("Atualizando perfil...", "info");
            
            try {
                const url = await uploadToImgBB(file);
                
                await updateProfile(user, { photoURL: url });
                await update(ref(db, `users/${user.uid}`), { photo: url });
                
                document.getElementById('settings-avatar').src = url;
                document.getElementById('sidebar-avatar').src = url;
                showToast("Foto atualizada!");
            } catch(e) {
                showToast("Erro: " + e.message, "error");
            }
        };

        // --- HELPERS ---
        window.createGroup = async () => {
            const name = document.getElementById('new-group-name').value;
            const r = await push(ref(db, 'groups'), { name, createdBy: user.uid });
            await update(ref(db, `users/${user.uid}/private_groups/${r.key}`), { groupName: name });
            closeModals();
        };

        window.addPrivateChat = async () => {
            const email = document.getElementById('new-contact-email').value;
            const s = await get(ref(db, 'users'));
            let uid = null, name = "";
            s.forEach(c => { if(c.val().email === email) { uid=c.key; name=c.val().name; }});
            if(uid) {
                const id = [user.uid, uid].sort().join("_");
                await update(ref(db, `users/${user.uid}/chats/${id}`), { friendName: name });
                await update(ref(db, `users/${uid}/chats/${id}`), { friendName: user.displayName });
                closeModals();
            } else { showToast("Não encontrado", "error"); }
        };

        window.saveProfileChanges = async () => {
            const name = document.getElementById('edit-name').value;
            if(name) {
                await updateProfile(user, { displayName: name });
                await update(ref(db, `users/${user.uid}`), { name });
                showToast("Nome salvo");
            }
        };

        window.openSettings = async () => {
            document.getElementById('modal-settings').style.display = 'flex';
            document.getElementById('settings-avatar').src = user.photoURL || "https://ui-avatars.com/api/?name=" + user.displayName;
            document.getElementById('edit-name').value = user.displayName;
        };
        window.openAddModal = () => document.getElementById('modal-add').style.display = 'flex';
        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');

    </script>
</body>
</html>
