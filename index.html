<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Chat GitHub</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #e5ddd5; height: 100vh; overflow: hidden; }
        
        /* Telas */
        .screen { display: none; height: 100%; width: 100%; }
        .active { display: flex; }

        /* Tela de Login */
        #auth-screen { flex-direction: column; justify-content: center; align-items: center; background: #00a884; }
        .card { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: center; }
        .card input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .card button { width: 100%; padding: 10px; background: #008069; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .card p { font-size: 14px; cursor: pointer; color: #008069; margin-top: 15px; }

        /* Tela Principal (App) */
        #app-screen { display: none; height: 100vh; }
        
        /* Sidebar (Grupos e Perfil) */
        .sidebar { width: 30%; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px; background: #f0f2f5; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #ccc; object-fit: cover; }
        .group-list { flex: 1; overflow-y: auto; }
        .group-item { padding: 15px; border-bottom: 1px solid #f0f2f5; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .group-item:hover { background: #f5f5f5; }
        .group-item.active-group { background: #ebebeb; }

        /* Área de Chat */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .chat-header { padding: 10px; background: #f0f2f5; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
        #messages-list { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        
        /* Mensagens */
        .msg { max-width: 60%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; word-wrap: break-word; }
        .msg.sent { align-self: flex-end; background: #d9fdd3; }
        .msg.received { align-self: flex-start; background: white; }
        .msg-sender { font-size: 10px; color: #666; font-weight: bold; margin-bottom: 3px; display: block; }
        .msg video, .msg img { max-width: 100%; border-radius: 5px; margin-top: 5px; }

        /* Input Area */
        .input-area { padding: 10px; background: #f0f2f5; display: flex; align-items: center; gap: 10px; }
        .input-area input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        .icon-btn { cursor: pointer; color: #54656f; font-size: 24px; background: none; border: none; }
        
        /* Modal Criar Grupo */
        #modal-group { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="auth-screen" class="screen active">
        <div class="card">
            <h2 id="auth-title">Entrar</h2>
            <input type="text" id="username" placeholder="Seu Nome (para cadastro)" style="display:none">
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="password" placeholder="Senha">
            <button id="auth-btn" onclick="handleLogin()">Entrar</button>
            <p id="toggle-auth" onclick="toggleAuthMode()">Não tem conta? Cadastre-se</p>
        </div>
    </div>

    <div id="app-screen" class="screen">
        <div class="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img id="my-avatar" class="avatar" src="https://via.placeholder.com/40">
                    <span id="my-name" style="font-weight:bold;">Carregando...</span>
                </div>
                <button class="icon-btn" onclick="openGroupModal()" title="Novo Grupo">+</button>
                <button class="icon-btn" onclick="logout()" title="Sair" style="font-size: 18px; color: red;">X</button>
            </div>
            <div class="group-list" id="group-list">
                </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <h3 id="chat-title" style="margin:0">Selecione um grupo</h3>
            </div>
            <div id="messages-list"></div>
            <div class="input-area" id="input-area" style="display:none;">
                <label for="file-input" class="icon-btn"><span class="material-icons">attach_file</span></label>
                <input type="file" id="file-input" style="display:none" onchange="uploadFile(this)">
                <input type="text" id="msg-input" placeholder="Digite uma mensagem...">
                <button class="icon-btn" onclick="sendMessage()"><span class="material-icons">send</span></button>
            </div>
        </div>
    </div>

    <div id="modal-group">
        <div class="card">
            <h3>Novo Grupo</h3>
            <input type="text" id="new-group-name" placeholder="Nome do Grupo">
            <button onclick="createGroup()">Criar</button>
            <button onclick="document.getElementById('modal-group').style.display='none'" style="background:#ccc; margin-top:5px">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // --- SUAS CHAVES AQUI ---
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJETO",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "NUMERO",
            appId: "ID_DO_APP"
        };
        // -----------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        let currentUser = null;
        let currentGroupId = null;
        let isRegistering = false;

        // --- AUTENTICAÇÃO ---
        window.toggleAuthMode = () => {
            isRegistering = !isRegistering;
            document.getElementById('auth-title').innerText = isRegistering ? "Cadastro" : "Entrar";
            document.getElementById('auth-btn').innerText = isRegistering ? "Cadastrar" : "Entrar";
            document.getElementById('toggle-auth').innerText = isRegistering ? "Já tem conta? Entre" : "Não tem conta? Cadastre-se";
            document.getElementById('username').style.display = isRegistering ? "block" : "none";
        };

        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('username').value;

            try {
                if (isRegistering) {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: name });
                    // Salva user no DB
                    set(ref(db, 'users/' + userCredential.user.uid), { name: name, email: email });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                alert("Erro: " + error.message);
            }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'flex';
                document.getElementById('my-name').innerText = user.displayName || user.email;
                document.getElementById('my-avatar').src = "https://ui-avatars.com/api/?name=" + (user.displayName || "U");
                loadGroups();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        // --- GRUPOS ---
        window.openGroupModal = () => document.getElementById('modal-group').style.display = 'flex';

        window.createGroup = () => {
            const name = document.getElementById('new-group-name').value;
            if (name) {
                push(ref(db, 'groups'), { name: name, createdBy: currentUser.uid });
                document.getElementById('modal-group').style.display = 'none';
                document.getElementById('new-group-name').value = '';
            }
        };

        function loadGroups() {
            const groupList = document.getElementById('group-list');
            groupList.innerHTML = "";
            onChildAdded(ref(db, 'groups'), (snapshot) => {
                const group = snapshot.val();
                const div = document.createElement('div');
                div.className = 'group-item';
                div.innerHTML = `<div class="avatar"></div><span>${group.name}</span>`;
                div.onclick = () => selectGroup(snapshot.key, group.name);
                groupList.appendChild(div);
            });
        }

        function selectGroup(groupId, groupName) {
            currentGroupId = groupId;
            document.getElementById('chat-title').innerText = groupName;
            document.getElementById('messages-list').innerHTML = "";
            document.getElementById('input-area').style.display = 'flex';
            
            // Carregar mensagens do grupo
            const messagesRef = ref(db, `messages/${groupId}`);
            onValue(messagesRef, (snapshot) => {
                const list = document.getElementById('messages-list');
                list.innerHTML = ""; // Limpa para recarregar (modo simples)
                snapshot.forEach((child) => {
                    const msg = child.val();
                    renderMessage(msg);
                });
                list.scrollTop = list.scrollHeight;
            });
        }

        // --- MENSAGENS E ARQUIVOS ---
        window.sendMessage = (fileUrl = null, type = 'text') => {
            if (!currentGroupId) return;
            const input = document.getElementById('msg-input');
            const text = input.value;

            if (text.trim() || fileUrl) {
                push(ref(db, `messages/${currentGroupId}`), {
                    text: text,
                    fileUrl: fileUrl,
                    type: type, // 'text', 'image', 'video'
                    sender: currentUser.displayName,
                    senderId: currentUser.uid,
                    timestamp: Date.now()
                });
                input.value = "";
            }
        };

        window.uploadFile = async (input) => {
            const file = input.files[0];
            if (!file) return;

            const type = file.type.startsWith('video') ? 'video' : 'image';
            const storageRef = sRef(storage, `uploads/${Date.now()}_${file.name}`);
            
            alert("Enviando arquivo... aguarde.");
            
            try {
                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);
                sendMessage(url, type);
            } catch (error) {
                console.error(error);
                alert("Erro no upload. Verifique se o Storage está ativado.");
            }
        };

        function renderMessage(msg) {
            const list = document.getElementById('messages-list');
            const isMe = msg.senderId === currentUser.uid;
            
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            let content = "";
            if (msg.type === 'video') {
                content = `<video src="${msg.fileUrl}" controls width="250"></video>`;
            } else if (msg.type === 'image') {
                content = `<img src="${msg.fileUrl}" width="200">`;
            }
            if (msg.text) content += `<div>${msg.text}</div>`;

            div.innerHTML = `<span class="msg-sender">${msg.sender}</span>${content}`;
            list.appendChild(div);
        }
    </script>
</body>
</html>
