<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Universe 8.0</title>
    <!-- Fontes e Ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --primary: #8b5cf6;       /* Roxo Principal */
            --primary-dark: #7c3aed;
            --bg-dark: #0f172a;       /* Fundo Escuro */
            --bg-panel: #1e293b;      /* Painéis */
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --glass: rgba(30, 41, 59, 0.7);
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #020617 0%, #111827 100%);
            height: 100dvh; color: var(--text-main); overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- COMPONENTES UI --- */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Botões */
        .btn {
            padding: 12px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: 600; font-size: 14px; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-secondary:hover { background: rgba(255,255,255,0.05); color: white; }
        .btn-icon { width: 40px; height: 40px; border-radius: 50%; background: transparent; color: var(--text-muted); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: var(--primary); }

        /* Scrollbar Bonita */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        /* --- LAYOUT PRINCIPAL --- */
        #app-screen { display: none; width: 100%; height: 100%; max-width: 1600px; position: relative; overflow: hidden; display: flex; }
        
        /* Sidebar */
        .sidebar {
            width: 300px; height: 100%; display: flex; flex-direction: column;
            background: rgba(15, 23, 42, 0.95); border-right: 1px solid var(--border);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute; left: 0; top: 0; z-index: 20;
        }
        .sidebar.closed { transform: translateX(-100%); } /* Esconder sidebar */

        .profile-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
        .profile-header:hover { background: rgba(255,255,255,0.03); }
        .avatar-small { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }

        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-item { padding: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 4px; color: var(--text-muted); transition: 0.2s; }
        .chat-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .chat-item.active { background: rgba(139, 92, 246, 0.15); color: white; border-left: 3px solid var(--primary); }

        /* Área do Chat */
        .chat-area {
            flex: 1; height: 100%; display: flex; flex-direction: column;
            background: #020617; position: relative;
            margin-left: 300px; /* Espaço da sidebar */
            transition: margin-left 0.3s ease;
        }
        .chat-area.full { margin-left: 0; } /* Quando sidebar fecha */

        .chat-header {
            height: 64px; border-bottom: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px);
            display: flex; align-items: center; padding: 0 20px; justify-content: space-between;
        }

        #messages-list { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }

        .msg { max-width: 75%; padding: 10px 16px; border-radius: 16px; font-size: 15px; line-height: 1.5; position: relative; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .msg.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: #334155; border-bottom-left-radius: 4px; }
        .msg-sender-name { font-size: 11px; font-weight: 600; margin-bottom: 4px; color: #a78bfa; opacity: 0.9; }

        /* Input Area */
        .input-area {
            padding: 15px; background: #0f172a; border-top: 1px solid var(--border);
            display: flex; gap: 10px; align-items: center; position: relative;
        }
        .input-box {
            flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            border-radius: 24px; padding: 12px 20px; color: white; font-size: 15px;
        }
        .input-box:focus { border-color: var(--primary); }

        /* Picker de Figurinhas */
        #sticker-picker {
            position: absolute; bottom: 80px; left: 20px; width: 320px; height: 350px;
            background: #1e293b; border: 1px solid var(--border);
            border-radius: 12px; display: none; flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5); z-index: 100;
        }
        #sticker-search { width: 100%; padding: 12px; background: transparent; border: none; border-bottom: 1px solid var(--border); color: white; }
        #sticker-results { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .sticker-img { width: 100%; height: 80px; object-fit: cover; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .sticker-img:hover { transform: scale(1.05); }

        /* --- MODAIS & LOGIN --- */
        #auth-screen { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: fixed; z-index: 200; background: var(--bg-dark); }
        .login-card { width: 350px; padding: 40px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; color: white; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 300; }
        .modal-content { width: 400px; padding: 0; overflow: hidden; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* Estilo do Perfil (Banner + Foto) */
        .profile-banner { height: 120px; background-color: #333; background-size: cover; background-position: center; position: relative; cursor: pointer; }
        .profile-banner:hover::after { content: 'Alterar Capa'; position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        
        .profile-avatar-edit { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #1e293b; position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); object-fit: cover; cursor: pointer; background: #000; }
        .profile-form { padding: 60px 30px 30px; text-align: center; }

        /* Toast */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .toast { background: #1e293b; color: white; padding: 12px 24px; border-radius: 30px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .chat-area { margin-left: 0; width: 100%; position: absolute; transform: translateX(100%); transition: transform 0.3s; }
            .chat-area.active { transform: translateX(0); }
            /* No mobile, sidebar closed means visible (logic inverted for UX) or use CSS transform */
            .sidebar.closed { transform: translateX(0); } /* Default state mobile */
            .chat-area.full { margin-left: 0; }
            #sticker-picker { width: 95%; left: 2.5%; bottom: 70px; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- TELA DE LOGIN -->
    <div id="auth-screen">
        <div class="glass-panel login-card">
            <h1 style="margin-bottom:20px; background: linear-gradient(to right, #a78bfa, #2dd4bf); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Chat Universe 8.0</h1>
            <input type="email" id="email" class="auth-input" placeholder="E-mail">
            <input type="password" id="password" class="auth-input" placeholder="Senha">
            <input type="text" id="username" class="auth-input" placeholder="Nome (Cadastro)" style="display:none">
            <button onclick="handleLogin()" id="btn-login" class="btn btn-primary" style="width:100%">ENTRAR</button>
            <button onclick="toggleAuth()" id="btn-toggle" class="btn btn-secondary" style="width:100%; margin-top:10px">Criar Conta</button>
        </div>
    </div>

    <!-- TELA DO APP -->
    <div id="app-screen" style="display:none">
        
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="profile-header" onclick="openSettings()">
                <img id="sidebar-avatar" class="avatar-small" src="">
                <div style="flex:1">
                    <div id="sidebar-name" style="font-weight:600">...</div>
                    <div style="font-size:12px; color:var(--text-muted)">Editar Perfil</div>
                </div>
                <span class="material-icons-round" style="color:var(--text-muted)">settings</span>
            </div>

            <div style="padding:15px">
                <button onclick="openAddModal()" class="btn btn-secondary" style="width:100%; justify-content: flex-start">
                    <span class="material-icons-round">add_comment</span> Nova Conversa
                </button>
            </div>
            
            <div class="chat-list" id="chat-list"></div>
            
            <div style="padding:15px; border-top:1px solid var(--border)">
                <button onclick="logout()" class="btn btn-secondary" style="width:100%; color:#ef4444; border-color: rgba(239,68,68,0.2)">
                    <span class="material-icons-round">logout</span> Sair
                </button>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="chat-area" id="chat-area">
            <div class="chat-header">
                <div style="display:flex; align-items:center; gap:15px">
                    <button class="btn-icon" onclick="toggleSidebar()">
                        <span class="material-icons-round">menu</span>
                    </button>
                    <div style="font-weight:600; font-size:1.1rem" id="chat-title-text">Selecione um Chat</div>
                </div>
            </div>
            
            <div id="messages-list">
                <div style="text-align:center; color:var(--text-muted); margin-top:50px">
                    <span class="material-icons-round" style="font-size:48px; opacity:0.5">chat_bubble_outline</span>
                    <p>Bem-vindo ao Chat Universe</p>
                </div>
            </div>

            <div class="input-area" id="input-area" style="display:none">
                <!-- Pop-up Figurinhas -->
                <div id="sticker-picker" class="glass-panel">
                    <input type="text" id="sticker-search" placeholder="Pesquisar Giphy..." onkeyup="searchStickers(this.value)">
                    <div id="sticker-results"></div>
                </div>

                <button class="btn-icon" onclick="toggleStickers()">
                    <span class="material-icons-round">emoji_emotions</span>
                </button>
                
                <label for="file-input" class="btn-icon">
                    <span class="material-icons-round">attach_file</span>
                </label>
                <input type="file" id="file-input" class="hidden-input" style="display:none" onclick="this.value=null" onchange="uploadFileImgBB(this)">
                
                <input type="text" id="msg-input" class="input-box" placeholder="Digite uma mensagem..." onkeypress="if(event.key==='Enter') sendMessage()">
                
                <button class="btn-icon" onclick="sendMessage()" style="background:var(--primary); color:white; border-radius:50%">
                    <span class="material-icons-round">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAIS -->
    
    <!-- Modal: Adicionar Conversa -->
    <div id="modal-add" class="modal">
        <div class="glass-panel modal-content" style="padding:25px">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h3>Nova Conversa</h3>
                <button class="btn-icon" onclick="closeModals()"><span class="material-icons-round">close</span></button>
            </div>
            
            <label style="font-size:12px; color:var(--text-muted); margin-bottom:5px; display:block">CRIAR GRUPO</label>
            <div style="display:flex; gap:10px; margin-bottom:20px">
                <input type="text" id="new-group-name" class="auth-input" placeholder="Nome do Grupo" style="margin:0">
                <button class="btn btn-primary" onclick="createGroup()">Criar</button>
            </div>
            
            <label style="font-size:12px; color:var(--text-muted); margin-bottom:5px; display:block">CHAT PRIVADO</label>
            <div style="display:flex; gap:10px">
                <input type="email" id="new-contact-email" class="auth-input" placeholder="E-mail do usuário" style="margin:0">
                <button class="btn btn-secondary" onclick="addPrivateChat()">Iniciar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Perfil (Banner + Avatar) -->
    <div id="modal-settings" class="modal">
        <div class="glass-panel modal-content">
            <button class="btn-icon" onclick="closeModals()" style="position:absolute; top:10px; right:10px; z-index:10; background:rgba(0,0,0,0.5); color:white"><span class="material-icons-round">close</span></button>
            
            <!-- Banner Upload -->
            <label for="banner-upload" style="width:100%">
                <div id="settings-banner" class="profile-banner"></div>
            </label>
            <input type="file" id="banner-upload" style="display:none" accept="image/*" onchange="uploadProfileBanner(this)">

            <!-- Avatar Upload -->
            <label for="avatar-upload">
                <img id="settings-avatar" class="profile-avatar-edit" src="">
            </label>
            <input type="file" id="avatar-upload" style="display:none" accept="image/*" onchange="uploadProfileAvatar(this)">

            <div class="profile-form">
                <h3 style="margin-bottom:20px">Editar Perfil</h3>
                <input type="text" id="edit-name" class="auth-input" placeholder="Seu Nome" style="text-align:center">
                <button class="btn btn-primary" style="width:100%; margin-top:10px" onclick="saveProfileChanges()">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // CONFIGS
        const firebaseConfig = {
            apiKey: "AIzaSyDLzKVUFDu9mL_38bQ65V6ATrUCyn1MmaY",
            authDomain: "chat-ba44c.firebaseapp.com",
            databaseURL: "https://chat-ba44c-default-rtdb.firebaseio.com",
            projectId: "chat-ba44c",
            storageBucket: "chat-ba44c.firebasestorage.app",
            messagingSenderId: "802680335472",
            appId: "1:802680335472:web:bf121d0615669c17fc58b5"
        };
        const GIPHY_API_KEY = "0UTRbFtkMxAplmr0kwDIziY866Snk3b0"; 
        const IMGBB_API_KEY = "4e5f37cc12948ad4ac9531a0fb466789"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let user = null;
        let currentChatId = null;
        let isRegistering = false;

        // UI HELPERS
        window.showToast = (msg) => {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = 'toast';
            div.innerHTML = `<span class="material-icons-round" style="color:#4ade80">check_circle</span> ${msg}`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        };

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const chatArea = document.getElementById('chat-area');
            
            if(window.innerWidth <= 768) {
                // Mobile: toggle active class on chat area (slides it)
                if(chatArea.classList.contains('active')) {
                    chatArea.classList.remove('active'); // Show sidebar
                } else {
                    chatArea.classList.add('active'); // Hide sidebar (show chat)
                }
            } else {
                // Desktop: collapse sidebar
                sidebar.classList.toggle('closed');
                chatArea.classList.toggle('full');
            }
        };

        // AUTH
        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const name = document.getElementById('username').value;
            try {
                if(isRegistering) {
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(cred.user, { displayName: name });
                    await set(ref(db, `users/${cred.user.uid}`), { name, email, photo: "", banner: "" });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) { alert(e.message); }
        };

        window.toggleAuth = () => {
            isRegistering = !isRegistering;
            document.getElementById('username').style.display = isRegistering ? 'block' : 'none';
            document.getElementById('btn-login').innerText = isRegistering ? 'CADASTRAR' : 'ENTRAR';
        };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                user = u;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'flex';
                updateProfileUI();
                loadChats();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        async function updateProfileUI() {
            const snap = await get(ref(db, `users/${user.uid}`));
            const d = snap.val() || {};
            const photo = d.photo || `https://ui-avatars.com/api/?name=${user.displayName}&background=8b5cf6&color=fff`;
            document.getElementById('sidebar-avatar').src = photo;
            document.getElementById('sidebar-name').innerText = user.displayName;
        }

        // CHAT LIST
        function loadChats() {
            const list = document.getElementById('chat-list');
            list.innerHTML = "";
            
            onChildAdded(ref(db, `users/${user.uid}/private_groups`), s => addItem(s.key, s.val().groupName, 'groups'));
            onChildAdded(ref(db, `users/${user.uid}/chats`), s => addItem(s.key, s.val().friendName, 'person'));

            function addItem(id, name, icon) {
                if(document.getElementById(`c-${id}`)) return;
                const div = document.createElement('div');
                div.id = `c-${id}`;
                div.className = 'chat-item';
                div.innerHTML = `<span class="material-icons-round">${icon}</span> ${name}`;
                div.onclick = () => openChat(id, name);
                list.appendChild(div);
            }
        }

        window.openChat = (id, name) => {
            currentChatId = id;
            document.getElementById('chat-title-text').innerText = name;
            document.getElementById('input-area').style.display = 'flex';
            document.getElementById('messages-list').innerHTML = "";
            
            // Mobile Transition
            if(window.innerWidth <= 768) {
                document.getElementById('chat-area').classList.add('active');
            }

            onValue(ref(db, `messages/${id}`), snap => {
                document.getElementById('messages-list').innerHTML = "";
                snap.forEach(c => renderMsg(c.val()));
                const d = document.getElementById('messages-list');
                d.scrollTop = d.scrollHeight;
            });
        };

        function renderMsg(msg) {
            const isMe = msg.senderId === user.uid;
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            
            let body = `<div>${msg.text}</div>`;
            if(msg.type === 'image') body = `<img src="${msg.text}" style="max-width:100%; border-radius:8px; margin-top:5px">`;
            if(msg.type === 'sticker') {
                body = `<img src="${msg.text}" style="max-width:140px; border-radius:8px">`;
                div.style.background = 'transparent'; div.style.boxShadow = 'none'; div.style.padding = '0';
            }

            if(!isMe) div.innerHTML = `<div class="msg-sender-name">${msg.sender}</div>${body}`;
            else div.innerHTML = body;
            
            document.getElementById('messages-list').appendChild(div);
        }

        window.sendMessage = (content=null, type='text') => {
            const inp = document.getElementById('msg-input');
            const txt = inp.value.trim();
            if(!content && !txt) return;

            push(ref(db, `messages/${currentChatId}`), {
                text: content || txt, type, sender: user.displayName, senderId: user.uid, timestamp: Date.now()
            });
            inp.value = "";
        };

        // IMGBB UPLOAD (FOTOS + BANNER + AVATAR)
        async function uploadImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const data = await res.json();
            return data.data.url;
        }

        window.uploadFileImgBB = async (ipt) => {
            if(ipt.files[0]) {
                showToast("Enviando...");
                const url = await uploadImgBB(ipt.files[0]);
                sendMessage(url, 'image');
            }
        };

        window.uploadProfileAvatar = async (ipt) => {
            if(ipt.files[0]) {
                const url = await uploadImgBB(ipt.files[0]);
                await updateProfile(user, { photoURL: url });
                await update(ref(db, `users/${user.uid}`), { photo: url });
                document.getElementById('settings-avatar').src = url;
                updateProfileUI();
            }
        };

        window.uploadProfileBanner = async (ipt) => {
            if(ipt.files[0]) {
                const url = await uploadImgBB(ipt.files[0]);
                await update(ref(db, `users/${user.uid}`), { banner: url });
                document.getElementById('settings-banner').style.backgroundImage = `url('${url}')`;
            }
        };

        // STICKERS
        window.toggleStickers = () => {
            const p = document.getElementById('sticker-picker');
            p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
            if(p.style.display === 'flex') searchStickers('trending');
        };

        window.searchStickers = async (q) => {
            if(!q) q = 'trending';
            const res = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${q}&limit=9&rating=g`);
            const json = await res.json();
            const div = document.getElementById('sticker-results');
            div.innerHTML = "";
            json.data.forEach(g => {
                const img = document.createElement('img');
                img.src = g.images.fixed_height_small.url;
                img.className = 'sticker-img';
                img.onclick = () => {
                    sendMessage(g.images.fixed_height.url, 'sticker');
                    document.getElementById('sticker-picker').style.display = 'none';
                };
                div.appendChild(img);
            });
        };

        // PROFILE SETTINGS
        window.openSettings = async () => {
            document.getElementById('modal-settings').style.display = 'flex';
            document.getElementById('edit-name').value = user.displayName;
            const snap = await get(ref(db, `users/${user.uid}`));
            const d = snap.val() || {};
            document.getElementById('settings-avatar').src = d.photo || user.photoURL;
            if(d.banner) document.getElementById('settings-banner').style.backgroundImage = `url('${d.banner}')`;
        };
        window.saveProfileChanges = async () => {
            const name = document.getElementById('edit-name').value;
            if(name) {
                await updateProfile(user, { displayName: name });
                await update(ref(db, `users/${user.uid}`), { name });
                updateProfileUI();
                closeModals();
                showToast("Perfil salvo!");
            }
        };

        // MODAL LOGIC
        window.createGroup = async () => {
            const n = document.getElementById('new-group-name').value;
            const r = await push(ref(db, 'groups'), { name: n });
            await update(ref(db, `users/${user.uid}/private_groups/${r.key}`), { groupName: n });
            closeModals();
        };
        window.addPrivateChat = async () => {
            const email = document.getElementById('new-contact-email').value;
            const s = await get(ref(db, 'users'));
            let uid = null, name = "";
            s.forEach(c => { if(c.val().email === email) { uid=c.key; name=c.val().name; } });
            if(uid) {
                const id = [user.uid, uid].sort().join("_");
                await update(ref(db, `users/${user.uid}/chats/${id}`), { friendName: name });
                await update(ref(db, `users/${uid}/chats/${id}`), { friendName: user.displayName });
                closeModals();
            } else alert("Não encontrado");
        };

        window.openAddModal = () => document.getElementById('modal-add').style.display = 'flex';
        window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    </script>
</body>
</html>
